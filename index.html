<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trợ lý Giọng nói AI</title>
    <!-- TailwindCSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Một vài custom style nhỏ để lấp đầy chiều cao trên mobile */
        html, body {
            height: 100%;
        }
        @media (max-width: 767px) {
            html, body {
                 height: -webkit-fill-available;
            }
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center font-sans">

    <div id="chat-container" class="bg-white w-full h-full flex flex-col shadow-lg md:max-w-2xl md:h-[85vh] md:max-h-[800px] md:rounded-lg overflow-hidden">
        <!-- Phần Header -->
        <div class="bg-blue-600 text-white p-4 flex-shrink-0 flex flex-col gap-3 shadow-md">
            <div class="flex justify-between items-center">
                <h1 class="text-lg font-semibold grow text-center ml-10">Trợ lý Giọng nói AI</h1>
                <button id="newChatButton" title="Cuộc trò chuyện mới" class="p-2 rounded-full hover:bg-blue-700 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 4v5h5M5.5 9.5L4 11l5 5L15 10l-1.5-1.5" />
                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v7.059a4.502 4.502 0 01-2.903 4.242l-1.11 3.558a.5.5 0 00.92.288l1.11-3.558A4.502 4.502 0 0115.5 11.56V4.5" />
                    </svg>
                </button>
            </div>
            <div class="flex gap-2 justify-center">
                <select id="languageSelect" class="bg-blue-700 text-white border border-blue-500 rounded p-1 text-sm max-w-[45%] focus:ring-2 focus:ring-white focus:outline-none">
                    <option value="vi-VN" selected>Tiếng Việt</option>
                    <option value="en-US">English</option>
                </select>
                <select id="voiceSelect" class="bg-blue-700 text-white border border-blue-500 rounded p-1 text-sm max-w-[45%] focus:ring-2 focus:ring-white focus:outline-none"></select>
            </div>
        </div>
        
        <!-- Khung Chat -->
        <div class="flex-grow p-4 overflow-y-auto space-y-4" id="chatLog">
             <!-- Tin nhắn sẽ được thêm vào đây -->
        </div>

        <!-- Phần Điều Khiển -->
        <div class="p-4 border-t border-gray-200 text-center flex-shrink-0 flex flex-col items-center gap-3">
            <button id="recordButton" disabled class="w-16 h-16 rounded-full border-none bg-blue-600 text-white cursor-pointer flex justify-center items-center transition-all duration-300 shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-4 focus:ring-blue-300 disabled:bg-blue-300 disabled:cursor-not-allowed">
                <!-- Icon Mic -->
                <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor">
                    <path d="M7 4a3 3 0 016 0v6a3 3 0 11-6 0V4z" />
                    <path fill-rule="evenodd" d="M7 3a1 1 0 000 2v6a1 1 0 102 0V5a1 1 0 10-2 0V3zM13 10a1 1 0 011-1v1a3 3 0 11-6 0v-1a1 1 0 112 0v1a1 1 0 102 0v-1a1 1 0 011 1zM5 10a1 1 0 011-1v1a5 5 0 008.236 3.829l.894.894a1 1 0 11-1.414 1.414l-.894-.894A5.002 5.002 0 005 11v-1a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
            </button>
            <div id="status" class="text-gray-600 text-sm italic min-h-[20px]">Đang khởi tạo AI...</div>
        </div>
    </div>
    
    <script type="module">
        // --- Firebase SDK ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-app.js";
        import { getAI, getGenerativeModel, GoogleAIBackend } from "https://www.gstatic.com/firebasejs/11.9.1/firebase-ai.js";

        // --- DOM Elements ---
        const recordButton = document.getElementById('recordButton');
        const statusDisplay = document.getElementById('status');
        const chatLog = document.getElementById('chatLog');
        const newChatButton = document.getElementById('newChatButton');
        const voiceSelect = document.getElementById('voiceSelect');
        const languageSelect = document.getElementById('languageSelect');

        // --- Firebase Configuration ---
        // !!! CẢNH BÁO BẢO MẬT !!!
        // API Key không nên được đặt trực tiếp ở đây trong môi trường production.
        // Hãy sử dụng Cloud Functions hoặc một backend proxy để bảo vệ key của bạn.
        const firebaseConfig = {
            apiKey: "AIzaSyBA_dBZVyGwX2y_PIWOB60AB-OHBAPAzlo",
            authDomain: "aivoice-7e506.firebaseapp.com",
            projectId: "aivoice-7e506",
            storageBucket: "aivoice-7e506.appspot.com",
            messagingSenderId: "1098820942481",
            appId: "1:1098820942481:web:c2f4bc50e13047ca2a5d30"
        };
        
        let model;
        let chatSession;
        let availableVoices = [];

        // --- Main Initialization ---
        async function main() {
            try {
                populateVoiceList();
                if (speechSynthesis.onvoiceschanged !== undefined) {
                    speechSynthesis.onvoiceschanged = populateVoiceList;
                }

                const app = initializeApp(firebaseConfig);
                const ai = getAI(app, { backend: new GoogleAIBackend() });
                model = getGenerativeModel(ai, { model: "gemini-1.5-flash-latest" });
                
                newChatButton.addEventListener('click', () => startNewConversation());
                languageSelect.addEventListener('change', handleLanguageChange);

                startNewConversation(true);

            } catch(e) {
                console.error("Initialization failed:", e);
                addMessageToLog(`Lỗi khởi tạo AI: ${e.message}.`, 'ai');
                statusDisplay.textContent = 'Lỗi khởi tạo AI!';
            }
        }
        
        // --- Event Handlers ---
        function handleLanguageChange() {
            if (recognition) {
                recognition.lang = languageSelect.value;
                console.log(`Speech recognition language set to: ${recognition.lang}`);
            }
            populateVoiceList();
            startNewConversation();
        }

        // --- Conversation Management ---
        function startNewConversation(isInitialLoad = false) {
            if (!model) return;

            chatSession = model.startChat({ history: [] });
            console.log("New chat session started!");
            chatLog.innerHTML = ''; 

            const lang = languageSelect.value;
            const initialMessage = lang.startsWith('vi')
                ? "Xin chào! Bạn muốn hỏi tôi điều gì hôm nay?"
                : "Hello! How can I help you today?";
            
            updateMessageInLog(addMessageToLog('', 'ai', true), initialMessage);

            if(isInitialLoad){
                 // Chỉ tự động đọc câu chào mừng khi tải lần đầu
                 speak(initialMessage);
            }

            recordButton.disabled = false;
            statusDisplay.textContent = lang.startsWith('vi') ? 'Nhấn để nói' : 'Press to speak';
        }


        main();

        // --- Web Speech API ---
        const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition;

        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = false;
            recognition.lang = languageSelect.value;
            recognition.interimResults = false;
            let isRecording = false;

            recordButton.addEventListener('click', () => {
                if (isRecording) {
                    recognition.stop();
                } else {
                    window.speechSynthesis.cancel(); // Dừng đọc nếu AI đang nói
                    recognition.start();
                }
            });
            
            const recordingClasses = ['bg-red-600', 'animate-pulse'];

            recognition.onstart = () => { isRecording = true; recordButton.classList.add(...recordingClasses); statusDisplay.textContent = languageSelect.value.startsWith('vi') ? 'Đang lắng nghe...' : 'Listening...'; };
            recognition.onend = () => { isRecording = false; recordButton.classList.remove(...recordingClasses); statusDisplay.textContent = languageSelect.value.startsWith('vi') ? 'Nhấn để nói' : 'Press to speak'; };
            recognition.onresult = (event) => { const transcript = event.results[0][0].transcript; addMessageToLog(transcript, 'user'); callGeminiAPI(transcript); };
            recognition.onerror = (event) => { console.error('Speech recognition error:', event.error); statusDisplay.textContent = `Lỗi: ${event.error}`; };
        } else {
            recordButton.disabled = true;
            const errorMsg = 'Trình duyệt không hỗ trợ nhận diện giọng nói.';
            statusDisplay.textContent = errorMsg;
            addMessageToLog(errorMsg, 'ai');
        }

        // --- UI Functions ---
        function addMessageToLog(text, sender, isLoading = false) {
            const messageId = `msg-${Date.now()}`;
            const messageElement = document.createElement('div');
            messageElement.id = messageId;
            
            const messageContainerClasses = ['flex', 'items-end', 'gap-2', 'max-w-[85%]'];
            if (sender === 'user') {
                messageContainerClasses.push('self-end', 'flex-row-reverse');
            } else {
                messageContainerClasses.push('self-start');
            }
            messageElement.className = messageContainerClasses.join(' ');

            const avatar = document.createElement('div');
            const avatarBaseClasses = 'w-8 h-8 rounded-full flex items-center justify-center font-bold text-xs flex-shrink-0 shadow';
            if (sender === 'user') {
                avatar.className = `${avatarBaseClasses} bg-blue-100 text-blue-600`;
                avatar.textContent = 'BẠN';
            } else {
                avatar.className = `${avatarBaseClasses} bg-gray-200 text-gray-700`;
                avatar.textContent = 'AI';
            }

            const bubbleContainer = document.createElement('div');
            bubbleContainer.className = 'flex items-center gap-2';

            const messageText = document.createElement('div');
            messageText.className = 'text-content px-4 py-2 rounded-2xl leading-relaxed';
            
            if (sender === 'user') {
                messageText.classList.add('bg-blue-600', 'text-white', 'rounded-br-lg');
            } else {
                messageText.classList.add('bg-gray-200', 'text-gray-800', 'rounded-bl-lg');
            }

            if (isLoading) {
                messageText.innerHTML = `
                    <div class="flex space-x-1.5">
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.3s]"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse [animation-delay:-0.15s]"></div>
                        <div class="w-2 h-2 bg-gray-400 rounded-full animate-pulse"></div>
                    </div>`;
            } else {
                 messageText.textContent = text;
            }

            bubbleContainer.appendChild(messageText);
            
            if (sender === 'ai') {
                const speakButton = document.createElement('button');
                speakButton.className = 'speak-btn p-1.5 rounded-full text-gray-500 hover:bg-gray-300 hover:text-gray-800 transition-colors hidden';
                speakButton.title = "Đọc văn bản";
                speakButton.innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path d="M10 3.612a.75.75 0 011.06 0l5.25 5.25a.75.75 0 01-1.06 1.06L11 5.44v9.06a.75.75 0 01-1.5 0V5.44L5.28 10.922a.75.75 0 01-1.06-1.06l5.25-5.25z" /><path d="M4.75 14A.75.75 0 004 14.75v.5c0 1.513 1.04 2.78 2.5 3.162V20a.75.75 0 001.5 0v-1.588A3.488 3.488 0 0012 15.25v-.5a.75.75 0 00-1.5 0v.5a2 2 0 01-4 0v-.5A.75.75 0 004.75 14z" /></svg>`;
                speakButton.onclick = () => {
                    const textToSpeak = messageElement.querySelector('.text-content').textContent;
                    speak(textToSpeak);
                };
                bubbleContainer.appendChild(speakButton);
            }
            
            messageElement.appendChild(avatar);
            messageElement.appendChild(bubbleContainer);

            chatLog.appendChild(messageElement);
            chatLog.scrollTop = chatLog.scrollHeight;
            return messageId;
        }

        function updateMessageInLog(messageId, newText) {
             const messageElement = document.getElementById(messageId);
             if (messageElement) {
                const textElement = messageElement.querySelector('.text-content');
                if(textElement) {
                    textElement.innerHTML = '';
                    textElement.textContent = newText;
                }
                
                const speakButton = messageElement.querySelector('.speak-btn');
                if (speakButton) {
                    speakButton.classList.remove('hidden');
                }
             }
        }

        function populateVoiceList() {
            setTimeout(() => {
                const selectedLang = languageSelect.value;
                const voices = speechSynthesis.getVoices();
                availableVoices = voices.filter(voice => voice.lang === selectedLang || voice.lang.startsWith(selectedLang.split('-')[0]));
                
                voiceSelect.innerHTML = '';
                if (availableVoices.length === 0) {
                    const option = document.createElement('option');
                    option.textContent = 'Không có giọng đọc';
                    voiceSelect.appendChild(option);
                    return;
                }
                
                availableVoices.forEach(voice => {
                    const option = document.createElement('option');
                    option.textContent = `${voice.name}`;
                    option.setAttribute('data-name', voice.name);
                    option.setAttribute('data-lang', voice.lang);
                    voiceSelect.appendChild(option);
                });
            }, 100);
        }

        function speak(text) {
            if ('speechSynthesis' in window) {
                window.speechSynthesis.cancel();

                const utterance = new SpeechSynthesisUtterance(text);
                const selectedOption = voiceSelect.selectedOptions[0];

                if (selectedOption && selectedOption.dataset.name) {
                    const selectedVoiceName = selectedOption.dataset.name;
                    const voice = availableVoices.find(v => v.name === selectedVoiceName);
                    if (voice) {
                        utterance.voice = voice;
                    }
                }
                
                utterance.lang = languageSelect.value;
                utterance.rate = 1.0;
                window.speechSynthesis.speak(utterance);
            }
        }
        
        // --- Real AI Logic with Context ---
        async function callGeminiAPI(prompt) {
            if (!chatSession) {
                addMessageToLog("Phiên trò chuyện chưa sẵn sàng.", 'ai');
                return;
            }
            
            statusDisplay.textContent = languageSelect.value.startsWith('vi') ? 'AI đang xử lý...' : 'AI is thinking...';
            recordButton.disabled = true;
            const thinkingMessageId = addMessageToLog('', 'ai', true);

            try {
                const result = await chatSession.sendMessage(prompt);
                const response = result.response;
                const text = response.text();
                
                updateMessageInLog(thinkingMessageId, text);
                
                // *** THAY ĐỔI: Tự động đọc câu trả lời của AI ***
                speak(text); 

            } catch (error) {
                console.error("Lỗi khi gọi Gemini API:", error);
                const errorText = `Đã xảy ra lỗi: ${error.message}`;
                updateMessageInLog(thinkingMessageId, errorText);
            } finally {
                statusDisplay.textContent = languageSelect.value.startsWith('vi') ? 'Nhấn để nói' : 'Press to speak';
                recordButton.disabled = false;
            }
        }
    </script>
</body>
</html>
